{% extends 'base.html' %}

{% block title %}Approval Examples - Medical Billing Validation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-700 mb-2 text-dark">
                <i class="bi bi-check2-circle me-2"></i>Approval Examples
            </h1>
            <p class="text-muted lead fw-500">Dynamic reference examples showing successful claim approvals with detailed breakdown.</p>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4 g-3">
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #e7f5ff 0%, #d0ebff 100%);">
                <div class="card-body">
                    <p class="text-muted fw-600 mb-2" style="font-size: 0.85rem;">TOTAL EXAMPLES</p>
                    <h3 class="text-dark fw-700 mb-0" id="exampleCount">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                <div class="card-body">
                    <p class="text-muted fw-600 mb-2" style="font-size: 0.85rem;">AVG. PROCESSING TIME</p>
                    <h3 class="text-dark fw-700 mb-0" id="avgTime">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <div class="card-body">
                    <p class="text-muted fw-600 mb-2" style="font-size: 0.85rem;">AVG. FRAUD RISK</p>
                    <h3 class="text-dark fw-700 mb-0" id="avgFraud">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);">
                <div class="card-body">
                    <p class="text-muted fw-600 mb-2" style="font-size: 0.85rem;">TOTAL PROCESSED</p>
                    <h3 class="text-dark fw-700 mb-0" id="totalProcessed">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label fw-600 text-dark mb-2">Filter by Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="APPROVED">Approved</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label fw-600 text-dark mb-2">Max Fraud Risk</label>
                            <input type="number" class="form-control" id="fraudFilter" placeholder="0.5" step="0.1" min="0" max="1">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label fw-600 text-dark mb-2">Min Amount</label>
                            <input type="number" class="form-control" id="minAmountFilter" placeholder="0">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label fw-600 text-dark mb-2">Max Amount</label>
                            <input type="number" class="form-control" id="maxAmountFilter" placeholder="10000">
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="applyFilters()">
                        <i class="bi bi-funnel me-1"></i>Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary mt-3" onclick="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Examples Grid -->
    <div class="row" id="examplesContainer">
        <!-- Dynamically populated -->
    </div>
</div>

<script>
let allExamples = [];

// Load approval examples on page load
document.addEventListener('DOMContentLoaded', function() {
    loadApprovalExamples();
    loadSummaryStats();
});

function loadApprovalExamples() {
    fetch('/api/approval-examples')
        .then(response => response.json())
        .then(data => {
            allExamples = data.examples;
            renderExamples(allExamples);
        })
        .catch(error => {
            console.error('Error loading examples:', error);
            document.getElementById('examplesContainer').innerHTML = 
                '<div class="col-12"><div class="alert alert-danger">Error loading approval examples</div></div>';
        });
}

function loadSummaryStats() {
    fetch('/api/approval-examples/summary')
        .then(response => response.json())
        .then(data => {
            document.getElementById('exampleCount').textContent = data.total_claims || 0;
            document.getElementById('avgTime').textContent = (data.avg_processing_time || 0).toFixed(1) + 's';
            document.getElementById('avgFraud').textContent = ((data.avg_fraud_risk || 0) * 100).toFixed(1) + '%';
            document.getElementById('totalProcessed').textContent = '$' + (data.total_amount || 0).toLocaleString('en-US', {maximumFractionDigits: 0}) + 'K';
        })
        .catch(error => console.error('Error loading summary:', error));
}

function renderExamples(examples) {
    const container = document.getElementById('examplesContainer');
    
    if (examples.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">No approval examples match your filters</div></div>';
        return;
    }

    container.innerHTML = examples.map(example => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100" style="transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 10px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                <div class="card-body">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1">
                                <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                    <i class="bi bi-check-circle me-1"></i>${example.status}
                                </span>
                            </h6>
                            <small class="text-muted fw-700" style="font-family: monospace;">${example.id}</small>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    <div class="mb-3">
                        <p class="mb-1"><small class="text-muted fw-600">PATIENT</small></p>
                        <p class="mb-0 fw-700 text-dark">${example.patient_name}</p>
                        <p class="mb-0"><small class="text-muted">ID: ${example.patient_id}</small></p>
                    </div>

                    <!-- Diagnosis & Procedure -->
                    <div class="mb-3">
                        <p class="mb-1"><small class="text-muted fw-600">DIAGNOSIS</small></p>
                        <p class="mb-2"><small class="text-dark"><strong>${example.diagnosis_code}</strong> - ${example.diagnosis_name}</small></p>
                        <p class="mb-1"><small class="text-muted fw-600">PROCEDURE</small></p>
                        <p class="mb-0"><small class="text-dark"><strong>${example.procedure_code}</strong> - ${example.procedure_name}</small></p>
                    </div>

                    <!-- Amount & Coverage -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted fw-600">TREATMENT COST</small>
                            <small class="fw-700 text-dark">$${example.treatment_cost.toLocaleString('en-US', {maximumFractionDigits: 2})}</small>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted fw-600">INSURANCE COVERAGE</small>
                            <small class="fw-700" style="color: #10b981;">${example.insurance_coverage}%</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted fw-600">PATIENT RESPONSIBILITY</small>
                            <small class="fw-700" style="color: #f59e0b;">${example.patient_responsibility}%</small>
                        </div>
                    </div>

                    <!-- Fraud Risk & Processing Time -->
                    <div class="mb-3">
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted fw-600">FRAUD RISK</small>
                                <small class="fw-700">${(example.fraud_risk_score * 100).toFixed(1)}%</small>
                            </div>
                            <div style="height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${Math.min(example.fraud_risk_score * 100, 100)}%; height: 100%; background: ${example.fraud_risk_score < 0.33 ? '#10b981' : example.fraud_risk_score < 0.66 ? '#f59e0b' : '#ef4444'}; border-radius: 3px;"></div>
                            </div>
                        </div>
                        <small class="text-muted">Processing Time: <strong>${example.processing_time_days.toFixed(1)} days</strong></small>
                    </div>

                    <!-- Approval Reason -->
                    <div class="p-2" style="background: #f8fafc; border-radius: 6px;">
                        <p class="mb-0"><small class="text-muted fw-600">APPROVAL REASON</small></p>
                        <p class="mb-0"><small class="text-dark">${example.approval_reason}</small></p>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const fraudRisk = document.getElementById('fraudFilter').value;
    const minAmount = document.getElementById('minAmountFilter').value;
    const maxAmount = document.getElementById('maxAmountFilter').value;

    let url = '/api/approval-examples?';
    if (status) url += `status=${status}&`;
    if (fraudRisk) url += `fraud_risk_max=${fraudRisk}&`;
    if (minAmount) url += `min_amount=${minAmount}&`;
    if (maxAmount) url += `max_amount=${maxAmount}&`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            allExamples = data.examples;
            renderExamples(allExamples);
        })
        .catch(error => console.error('Error applying filters:', error));
}

function resetFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('fraudFilter').value = '';
    document.getElementById('minAmountFilter').value = '';
    document.getElementById('maxAmountFilter').value = '';
    loadApprovalExamples();
}
</script>

<style>
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}
