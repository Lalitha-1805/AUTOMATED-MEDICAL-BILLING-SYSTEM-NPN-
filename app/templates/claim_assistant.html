{% extends "base.html" %}

{% block title %}Claim Assistance Bot{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <!-- Header -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-robot"></i> Claim Assistance Bot
                    </h3>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        Get clear, professional explanations about your claim validation results. 
                        Ask about rejections, violations, missing documents, or fraud risk scores.
                    </p>
                </div>
            </div>

            <!-- Claim Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Step 1: Select Your Claim</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="claimSelect">Choose a claim to analyze:</label>
                        <select id="claimSelect" class="form-control">
                            <option value="">-- Select a claim --</option>
                            {% if recent_claims %}
                                {% for claim in recent_claims %}
                                    <option value="{{ claim.id }}">
                                        Claim #{{ claim.claim_id }} ({{ claim.status }})
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No claims found</option>
                            {% endif %}
                        </select>
                    </div>
                    <small class="text-muted">
                        Only your recent claims are shown. Contact support to view older claims.
                    </small>
                </div>
            </div>

            <!-- Claim Explanation Display -->
            <div id="explanationContainer" style="display: none;" class="mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-check"></i> Claim Explanation
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="explanationContent" style="white-space: pre-wrap; font-family: monospace; line-height: 1.6;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions Section -->
            <div id="questionsContainer" style="display: none;" class="mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Step 2: Ask a Question</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <strong>Common Questions:</strong>
                        </p>
                        <div class="btn-group-vertical w-100 mb-3" role="group">
                            <button type="button" class="btn btn-outline-info text-start" onclick="askQuestion('Why was my claim rejected?')">
                                Why was my claim rejected?
                            </button>
                            <button type="button" class="btn btn-outline-info text-start" onclick="askQuestion('What rule violations were detected?')">
                                What rule violations were detected?
                            </button>
                            <button type="button" class="btn btn-outline-info text-start" onclick="askQuestion('What documents are missing?')">
                                What documents are missing?
                            </button>
                            <button type="button" class="btn btn-outline-info text-start" onclick="askQuestion('What does my fraud risk score mean?')">
                                What does my fraud risk score mean?
                            </button>
                            <button type="button" class="btn btn-outline-info text-start" onclick="askQuestion('How can I fix my claim?')">
                                How can I fix my claim?
                            </button>
                        </div>

                        <hr>

                        <p class="text-muted mb-3">
                            <strong>Or ask your own question:</strong>
                        </p>
                        <div class="input-group">
                            <input 
                                id="questionInput" 
                                type="text" 
                                class="form-control" 
                                placeholder="Type your question here..."
                                onkeypress="if(event.key==='Enter') askQuestion(document.getElementById('questionInput').value)"
                            >
                            <button 
                                class="btn btn-primary" 
                                type="button"
                                onclick="askQuestion(document.getElementById('questionInput').value)"
                            >
                                <i class="fas fa-paper-plane"></i> Ask
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Answer Display -->
            <div id="answerContainer" style="display: none;" class="mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-comments"></i> Assistant Response
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="answerQuestion" class="mb-3 font-weight-bold text-primary">
                            <!-- Question display -->
                        </div>
                        <div id="answerContent" style="white-space: pre-wrap; line-height: 1.6;">
                            <!-- Answer will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" style="display: none; text-align: center;" class="my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Analyzing your claim...</p>
            </div>

            <!-- Error Display -->
            <div id="errorAlert" style="display: none;" class="alert alert-danger alert-dismissible fade show" role="alert">
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <strong>Error:</strong> <span id="errorMessage"></span>
            </div>

            <!-- Disclaimer -->
            <div class="alert alert-light border mt-4">
                <p class="mb-0">
                    <strong>Important:</strong> This bot explains existing validation results only. 
                    It does not modify decisions, perform new validation, or provide medical/legal advice. 
                    For policy disputes or appeals, contact your insurance provider directly.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .btn-group-vertical .btn {
        border: 1px solid #17a2b8;
        margin-bottom: 0.5rem;
    }
    
    .btn-group-vertical .btn:hover {
        background-color: #e7f3f5;
    }
    
    #explanationContent, #answerContent {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        border-left: 4px solid #17a2b8;
    }
    
    .card-header {
        font-weight: 600;
    }
</style>

<script>
    let currentClaimId = null;

    // Handle claim selection
    document.getElementById('claimSelect').addEventListener('change', function() {
        currentClaimId = this.value;
        
        if (!currentClaimId) {
            document.getElementById('explanationContainer').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'none';
            document.getElementById('answerContainer').style.display = 'none';
            return;
        }
        
        fetchClaimExplanation();
    });

    function fetchClaimExplanation() {
        if (!currentClaimId) {
            showError('Please select a claim first.');
            return;
        }

        showLoading(true);
        hideError();

        fetch(`/api/claim-explanation/${currentClaimId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showLoading(false);
                
                // Display explanation
                document.getElementById('explanationContent').textContent = data.full_response;
                document.getElementById('explanationContainer').style.display = 'block';
                document.getElementById('questionsContainer').style.display = 'block';
                document.getElementById('answerContainer').style.display = 'none';
                
                // Clear previous answer
                document.getElementById('questionInput').value = '';
            })
            .catch(error => {
                showLoading(false);
                showError('Failed to fetch claim explanation. Please try again.');
                console.error('Error:', error);
            });
    }

    function askQuestion(questionText) {
        if (!currentClaimId) {
            showError('Please select a claim first.');
            return;
        }

        const question = questionText || document.getElementById('questionInput').value;
        
        if (!question.trim()) {
            showError('Please enter a question.');
            return;
        }

        showLoading(true);
        hideError();

        fetch(`/api/bot-question/${currentClaimId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            showLoading(false);
            
            // Display question and answer
            document.getElementById('answerQuestion').textContent = `Q: ${data.question}`;
            document.getElementById('answerContent').textContent = data.answer;
            document.getElementById('answerContainer').style.display = 'block';
            
            // Clear input
            document.getElementById('questionInput').value = '';
        })
        .catch(error => {
            showLoading(false);
            showError('Failed to get answer. Please try again.');
            console.error('Error:', error);
        });
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorAlert').style.display = 'block';
    }

    function hideError() {
        document.getElementById('errorAlert').style.display = 'none';
    }
</script>
{% endblock %}
